# Decision: Cloudflare D1 + Drizzle ORM

## Status

Accepted

## Context

This project runs on Cloudflare Workers. We need a database that:

- Works natively in the Cloudflare edge runtime
- Supports SQL for structured data
- Has good TypeScript support
- Integrates well with the existing Wrangler deployment workflow

## Decision

Use **Cloudflare D1** as the database and **Drizzle ORM** for schema management
and queries.

### Cloudflare D1

D1 is Cloudflare's serverless SQLite database. It integrates directly with
Workers via bindings (no connection strings, no connection pooling), and
Wrangler handles local development with a SQLite file so there's no separate
database process to run.

### Drizzle ORM

Drizzle is a lightweight TypeScript ORM that works with D1's SQLite dialect. It
provides:

- Type-safe query builder
- Schema-as-code with `drizzle-kit generate` to produce SQL migration files
- Drizzle Studio for browsing the database locally

Migrations are generated by Drizzle Kit and applied by Wrangler, which tracks
applied migrations in D1's built-in migration table.

## Setup

### One-time: Create the D1 database

```bash
wrangler d1 create freedom-seed
```

Copy the `database_id` from the output and paste it into `wrangler.jsonc`.

### Schema changes

1. Edit `app/db/schema.ts`
2. Generate a migration: `npm run db:generate`
3. Apply locally: `npm run db:migrate`
4. Apply to production after deploy: `npm run db:migrate:remote`

### Using the database in loaders/actions

```ts
import { getDb } from '~/db/client.server'
import { getCloudflare } from '~/utils/cloudflare-context'

export async function loader({ context }: Route.LoaderArgs) {
	const { env } = getCloudflare(context)
	const db = getDb(env)
	// use db...
}
```

## Consequences

- **No SQL transactions** — D1 does not support `BEGIN/COMMIT`. Use
  `db.batch([...])` for atomic multi-statement operations.
- **Dates as integers** — SQLite has no native date type; use
  `integer('col', { mode: 'timestamp' })` with `.$defaultFn(() => new Date())`.
- **Migration workflow** — `drizzle-kit push` is not used; always generate SQL
  files and apply with Wrangler.
